const { body } = require('express-validator');
const { validate } = require('../middleware/validator');
const Workspace = require('../models/Workspace');
const User = require('../models/User');
const Invitation = require('../models/Invitation');
const WorkspaceInvitation = require('../models/WorkspaceInvitation');
const { successResponse, errorResponse } = require('../utils/responseUtils');
const crypto = require('crypto');
const { sendEmail, workspaceInviteEmail } = require('../services/emailService');

// @desc    Create workspace
// @route   POST /api/workspaces
// @access  Private
const createWorkspace = async (req, res, next) => {
    try {
        const { name, description } = req.body;

        const workspace = await Workspace.create({
            name,
            description,
            owner: req.user._id,
        });

        // Add workspace to user's workspaces
        await User.findByIdAndUpdate(req.user._id, {
            $push: { workspaces: workspace._id },
        });

        successResponse(res, 201, 'Workspace created successfully', { workspace });
    } catch (error) {
        next(error);
    }
};

// @desc    Get all user workspaces
// @route   GET /api/workspaces
// @access  Private
const getWorkspaces = async (req, res, next) => {
    try {
        const workspaces = await Workspace.find({
            'members.user': req.user._id,
        }).populate('members.user', 'name email avatar');

        successResponse(res, 200, 'Workspaces retrieved successfully', {
            workspaces,
        });
    } catch (error) {
        next(error);
    }
};

// @desc    Get workspace by ID
// @route   GET /api/workspaces/:workspaceId
// @access  Private
const getWorkspaceById = async (req, res, next) => {
    try {
        const { workspaceId } = req.params;

        const workspace = await Workspace.findById(workspaceId)
            .populate('members.user', 'name email avatar')
            .populate('projects');

        if (!workspace) {
            return errorResponse(res, 404, 'Workspace not found');
        }

        successResponse(res, 200, 'Workspace retrieved successfully', { workspace });
    } catch (error) {
        next(error);
    }
};

// @desc    Update workspace
// @route   PATCH /api/workspaces/:workspaceId
// @access  Private (Admin/Owner)
const updateWorkspace = async (req, res, next) => {
    try {
        const { workspaceId } = req.params;
        const { name, description } = req.body;

        const workspace = await Workspace.findByIdAndUpdate(
            workspaceId,
            { name, description },
            { new: true, runValidators: true }
        );

        successResponse(res, 200, 'Workspace updated successfully', { workspace });
    } catch (error) {
        next(error);
    }
};

// @desc    Delete workspace
// @route   DELETE /api/workspaces/:workspaceId
// @access  Private (Owner only)
const deleteWorkspace = async (req, res, next) => {
    try {
        const { workspaceId } = req.params;

        await Workspace.findByIdAndDelete(workspaceId);

        // Remove workspace from all members
        await User.updateMany(
            { workspaces: workspaceId },
            { $pull: { workspaces: workspaceId } }
        );

        successResponse(res, 200, 'Workspace deleted successfully');
    } catch (error) {
        next(error);
    }
};

// @desc    Generate invite link
// @route   POST /api/workspaces/:workspaceId/invite
// @access  Private (Admin/Owner)
const generateInvite = async (req, res, next) => {
    try {
        const { workspaceId } = req.params;
        const { email, role } = req.body;

        const workspace = await Workspace.findById(workspaceId);

        // Check if user is already a member
        const existingMember = workspace.members.find(
            (m) => m.user.toString() === email
        );

        if (existingMember) {
            return errorResponse(res, 400, 'User is already a member');
        }

        // Generate unique token
        const token = crypto.randomBytes(32).toString('hex');

        // Create invitation
        const invitation = await Invitation.create({
            workspace: workspaceId,
            email,
            role: role || 'Member',
            token,
            invitedBy: req.user._id,
        });

        // Send email invitation
        const inviteUrl = `${process.env.CLIENT_URL}/invite/${token}`;
        const html = workspaceInviteEmail(email, workspace.name, req.user.name, inviteUrl);

        await sendEmail({
            to: email,
            subject: `Invitation to join ${workspace.name}`,
            html,
        }).catch(err => console.error('Email send error:', err));

        successResponse(res, 201, 'Invitation sent successfully', {
            invitation: {
                email: invitation.email,
                role: invitation.role,
                inviteUrl,
            },
        });
    } catch (error) {
        next(error);
    }
};

// @desc    Join workspace via invite
// @route   POST /api/workspaces/join/:token
// @access  Private
const joinWorkspace = async (req, res, next) => {
    try {
        const { token } = req.params;

        const invitation = await Invitation.findOne({ token, status: 'pending' });

        if (!invitation) {
            return errorResponse(res, 404, 'Invalid or expired invitation');
        }

        if (invitation.expiresAt < new Date()) {
            invitation.status = 'expired';
            await invitation.save();
            return errorResponse(res, 400, 'Invitation has expired');
        }

        const workspace = await Workspace.findById(invitation.workspace);

        // Add user to workspace
        workspace.members.push({
            user: req.user._id,
            role: invitation.role,
        });
        await workspace.save();

        // Add workspace to user
        await User.findByIdAndUpdate(req.user._id, {
            $push: { workspaces: workspace._id },
        });

        // Update invitation status
        invitation.status = 'accepted';
        await invitation.save();

        successResponse(res, 200, 'Successfully joined workspace', { workspace });
    } catch (error) {
        next(error);
    }
};

// @desc    Remove member from workspace
// @route   DELETE /api/workspaces/:workspaceId/members/:userId
// @access  Private (Admin/Owner)
const removeMember = async (req, res, next) => {
    try {
        const { workspaceId, userId } = req.params;

        const workspace = await Workspace.findById(workspaceId);

        // Remove member
        workspace.members = workspace.members.filter(
            (m) => m.user.toString() !== userId
        );
        await workspace.save();

        // Remove workspace from user
        ```javascript
        next(error);
    }
};

// @desc    Get all user workspaces
// @route   GET /api/workspaces
// @access  Private
const getWorkspaces = async (req, res, next) => {
    try {
        const workspaces = await Workspace.find({
            'members.user': req.user._id,
        }).populate('members.user', 'name email avatar');

        successResponse(res, 200, 'Workspaces retrieved successfully', {
            workspaces,
        });
    } catch (error) {
        next(error);
    }
};

// @desc    Get workspace by ID
// @route   GET /api/workspaces/:workspaceId
// @access  Private
const getWorkspaceById = async (req, res, next) => {
    try {
        const { workspaceId } = req.params;

        const workspace = await Workspace.findById(workspaceId)
            .populate('members.user', 'name email avatar')
            .populate('projects');

        if (!workspace) {
            return errorResponse(res, 404, 'Workspace not found');
        }

        successResponse(res, 200, 'Workspace retrieved successfully', { workspace });
    } catch (error) {
        next(error);
    }
};

// @desc    Update workspace
// @route   PATCH /api/workspaces/:workspaceId
// @access  Private (Admin/Owner)
const updateWorkspace = async (req, res, next) => {
    try {
        const { workspaceId } = req.params;
        const { name, description } = req.body;

        const workspace = await Workspace.findByIdAndUpdate(
            workspaceId,
            { name, description },
            { new: true, runValidators: true }
        );

        successResponse(res, 200, 'Workspace updated successfully', { workspace });
    } catch (error) {
        next(error);
    }
};

// @desc    Delete workspace
// @route   DELETE /api/workspaces/:workspaceId
// @access  Private (Owner only)
const deleteWorkspace = async (req, res, next) => {
    try {
        const { workspaceId } = req.params;

        await Workspace.findByIdAndDelete(workspaceId);

        // Remove workspace from all members
        await User.updateMany(
            { workspaces: workspaceId },
            { $pull: { workspaces: workspaceId } }
        );

        successResponse(res, 200, 'Workspace deleted successfully');
    } catch (error) {
        next(error);
    }
};

// @desc    Generate invite link
// @route   POST /api/workspaces/:workspaceId/invite
// @access  Private (Admin/Owner)
const generateInvite = async (req, res, next) => {
    try {
        const { workspaceId } = req.params;
        const { email, role } = req.body;

        const workspace = await Workspace.findById(workspaceId);

        // Check if user is already a member
        const existingMember = workspace.members.find(
            (m) => m.user.toString() === email
        );

        if (existingMember) {
            return errorResponse(res, 400, 'User is already a member');
        }

        // Generate unique token
        const token = crypto.randomBytes(32).toString('hex');

        // Create invitation
        const invitation = await Invitation.create({
            workspace: workspaceId,
            email,
            role: role || 'Member',
            token,
            invitedBy: req.user._id,
        });

        // Send email invitation
        const inviteUrl = `${ process.env.CLIENT_URL } /invite/${ token } `;
        const html = workspaceInviteEmail(email, workspace.name, req.user.name, inviteUrl);

        await sendEmail({
            to: email,
            subject: `Invitation to join ${ workspace.name } `,
            html,
        }).catch(err => console.error('Email send error:', err));

        successResponse(res, 201, 'Invitation sent successfully', {
            invitation: {
                email: invitation.email,
                role: invitation.role,
                inviteUrl,
            },
        });
    } catch (error) {
        next(error);
    }
};

// @desc    Join workspace via invite
// @route   POST /api/workspaces/join/:token
// @access  Private
const joinWorkspace = async (req, res, next) => {
    try {
        const { token } = req.params;

        const invitation = await Invitation.findOne({ token, status: 'pending' });

        if (!invitation) {
            return errorResponse(res, 404, 'Invalid or expired invitation');
        }

        if (invitation.expiresAt < new Date()) {
            invitation.status = 'expired';
            await invitation.save();
            return errorResponse(res, 400, 'Invitation has expired');
        }

        const workspace = await Workspace.findById(invitation.workspace);

        // Add user to workspace
        workspace.members.push({
            user: req.user._id,
            role: invitation.role,
        });
        await workspace.save();

        // Add workspace to user
        await User.findByIdAndUpdate(req.user._id, {
            $push: { workspaces: workspace._id },
        });

        // Update invitation status
        invitation.status = 'accepted';
        await invitation.save();

        successResponse(res, 200, 'Successfully joined workspace', { workspace });
    } catch (error) {
        next(error);
    }
};

// @desc    Remove member from workspace
// @route   DELETE /api/workspaces/:workspaceId/members/:userId
// @access  Private (Admin/Owner)
const removeMember = async (req, res, next) => {
    try {
        const { workspaceId, userId } = req.params;

        const workspace = await Workspace.findById(workspaceId);

        if (!workspace) {
            return errorResponse(res, 404, 'Workspace not found');
        }

        // Cannot remove owner
        if (workspace.owner && workspace.owner.toString() === userId) {
            return errorResponse(res, 400, 'Cannot remove workspace owner');
        }

        // Remove member
        workspace.members = workspace.members.filter(
            (member) => member.user.toString() !== userId
        );

        await workspace.save();

        // Remove workspace from user's workspaces
        await User.findByIdAndUpdate(userId, {
            $pull: { workspaces: workspaceId },
        });

        successResponse(res, 200, 'Member removed successfully');
    } catch (error) {
        next(error);
    }
};

// @desc    Invite user to workspace
// @route   POST /api/workspaces/:workspaceId/invite
// @access  Private (Admin only)
const inviteUser = async (req, res, next) => {
    try {
        const { workspaceId } = req.params;
        const { email, role = 'member' } = req.body;

        const workspace = await Workspace.findById(workspaceId);

        if (!workspace) {
            return errorResponse(res, 404, 'Workspace not found');
        }

        // Check if email is already a member
        const existingMember = workspace.members.find(
            (member) => member.user.email === email
        );

        if (existingMember) {
            return errorResponse(res, 400, 'User is already a member of this workspace');
        }

        // Check if there's already a pending invitation
        const existingInvitation = await WorkspaceInvitation.findOne({
            workspace: workspaceId,
            email,
            status: 'pending',
        });

        if (existingInvitation) {
            return errorResponse(res, 400, 'An invitation has already been sent to this email');
        }

        // Create invitation
        const invitation = await WorkspaceInvitation.create({
            workspace: workspaceId,
            invitedBy: req.user._id,
            email,
            role,
        });

        // Send invitation email
        const inviteLink = `${ process.env.FRONTEND_URL } /invitations/${ invitation.token } `;
        
        await sendEmail({
            to: email,
            subject: `You've been invited to ${workspace.name}`,
        html: workspaceInviteEmail(
            workspace.name,
            req.user.name,
            inviteLink
        ),
        });

    successResponse(res, 201, 'Invitation sent successfully', { invitation });
} catch (error) {
    next(error);
}
};

// Validation
const createWorkspaceValidation = [
    body('name').trim().notEmpty().withMessage('Workspace name is required'),
    validate,
];

const inviteValidation = [
    body('email').isEmail().withMessage('Valid email is required'),
    body('role')
        .optional()
        .isIn(['admin', 'member'])
        .withMessage('Role must be admin or member'),
    validate,
];

module.exports = {
    createWorkspace,
    getWorkspaces,
    getWorkspaceById,
    updateWorkspace,
    deleteWorkspace,
    generateInvite,
    joinWorkspace,
    removeMember,
    inviteUser,
    createWorkspaceValidation,
    inviteValidation,
};

