import React, { useState, useEffect } from 'react';
import { useParams } from 'react-router-dom';
import {
    useGetWorkspacesQuery,
    useCreateWorkspaceMutation,
    useDeleteWorkspaceMutation,
    useInviteMemberMutation
} from '../features/workspaces/workspaceAPI';
import { useGetProjectsQuery, useDeleteProjectMutation } from '../features/projects/projectAPI';
import LoadingSpinner from '../components/common/LoadingSpinner';
import EmptyState from '../components/common/EmptyState';
import Button from '../components/common/Button';
import Modal from '../components/common/Modal';
import Input from '../components/common/Input';
import CreateProjectModal from '../components/modals/CreateProjectModal';
import EditWorkspaceModal from '../components/modals/EditWorkspaceModal';
import EditProjectModal from '../components/modals/EditProjectModal';
import toast from '../utils/toast';
import { FiPlus, FiGrid, FiFolder, FiTrash2, FiEdit, FiUserPlus } from 'react-icons/fi';

const WorkspaceList = () => {
    const [showCreateModal, setShowCreateModal] = useState(false);
    const [showCreateProjectModal, setShowCreateProjectModal] = useState(false);
    const [showEditWorkspaceModal, setShowEditWorkspaceModal] = useState(false);
    const [showEditProjectModal, setShowEditProjectModal] = useState(false);
    const [showInviteModal, setShowInviteModal] = useState(false);
    const [selectedWorkspaceForEdit, setSelectedWorkspaceForEdit] = useState(null);
    const [selectedProjectForEdit, setSelectedProjectForEdit] = useState(null);
    const [newWorkspace, setNewWorkspace] = useState({ name: '', description: '' });
    const [inviteEmail, setInviteEmail] = useState('');
    const [inviteRole, setInviteRole] = useState('member');
    const [selectedWorkspace, setSelectedWorkspace] = useState(null);

    const { data: workspacesData, isLoading, refetch } = useGetWorkspacesQuery();
    const [createWorkspace, { isLoading: isCreating }] = useCreateWorkspaceMutation();
    const [deleteWorkspace] = useDeleteWorkspaceMutation();
    const [deleteProject] = useDeleteProjectMutation();
    const [inviteMember, { isLoading: isInviting }] = useInviteMemberMutation();

    // Correctly extract workspaces from the nested data structure
    const workspaces = Array.isArray(workspacesData?.data?.workspaces)
        ? workspacesData.data.workspaces
        : Array.isArray(workspacesData?.data)
            ? workspacesData.data
            : [];

    // Set initial workspace when data loads - FIX: Only watch workspaces.length
    useEffect(() => {
        if (workspaces.length > 0 && !selectedWorkspace) {
            setSelectedWorkspace(workspaces[0]);
        }
    }, [workspaces.length]); // CRITICAL: Only watch length, not the array!

    const { data: projectsData, refetch: refetchProjects } = useGetProjectsQuery(selectedWorkspace?._id, {
        skip: !selectedWorkspace?._id,
    });

    // Extract projects safely
    const projects = Array.isArray(projectsData?.data?.projects)
        ? projectsData.data.projects
        : Array.isArray(projectsData?.data)
            ? projectsData.data
            : [];

    const handleCreateWorkspace = async (e) => {
        e.preventDefault();
        try {
            await createWorkspace(newWorkspace).unwrap();
            toast.success('Workspace created successfully!');
            setShowCreateModal(false);
            setNewWorkspace({ name: '', description: '' });
            refetch();
        } catch (error) {
            console.error('Failed to create workspace:', error);
            toast.error(error?.data?.message || 'Failed to create workspace');
        }
    };

    const handleDeleteWorkspace = async (id) => {
        if (window.confirm('Are you sure you want to delete this workspace? All projects within will be deleted.')) {
            try {
                await deleteWorkspace(id).unwrap();
                toast.success('Workspace deleted successfully');
            } catch (error) {
                console.error('Failed to delete workspace:', error);
                toast.error(error?.data?.message || 'Failed to delete workspace');
            }
        }
    };

    const handleDeleteProject = async (id) => {
        if (window.confirm('Are you sure you want to delete this project? All tasks within will be deleted.')) {
            try {
                await deleteProject(id).unwrap();
                toast.success('Project deleted successfully');
                refetchProjects();
            } catch (error) {
                console.error('Failed to delete project:', error);
                toast.error(error?.data?.message || 'Failed to delete project');
            }
        }
    };

    const handleSendInvite = async (e) => {
        e.preventDefault();
        try {
            await inviteMember({
                workspaceId: selectedWorkspace._id,
                email: inviteEmail,
                role: inviteRole,
            }).unwrap();

            toast.success(`Invitation sent to ${inviteEmail}!`);
            setShowInviteModal(false);
            setInviteEmail('');
            setInviteRole('member');
        } catch (error) {
            console.error('Failed to send invite:', error);
            toast.error(error?.data?.message || 'Failed to send invitation');
        }
    };

    if (isLoading) {
        return (
            <div className="flex items-center justify-center h-64">
                <LoadingSpinner size="lg" />
            </div>
        );
    }

    return (
        <div className="space-y-6">
            <div className="flex items-center justify-between">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">Workspaces</h1>
                    <p className="text-gray-600 mt-1">
                        Organize your projects into workspaces
                    </p>
                </div>
                <Button onClick={() => setShowCreateModal(true)}>
                    <FiPlus className="w-4 h-4 mr-2" />
                    New Workspace
                </Button>
            </div>

            {workspaces.length === 0 ? (
                <EmptyState
                    icon={FiGrid}
                    title="No workspaces yet"
                    description="Create your first workspace to start organizing your projects"
                    action={
                        <Button onClick={() => setShowCreateModal(true)}>
                            <FiPlus className="w-4 h-4 mr-2" />
                            Create Workspace
                        </Button>
                    }
                />
            ) : (
                <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <div className="lg:col-span-1 bg-white rounded-lg shadow p-4 space-y-2 h-fit">
                        <h3 className="font-semibold text-gray-900 mb-4">All Workspaces</h3>
                        {workspaces.map((workspace) => (
                            <div
                                key={workspace._id}
                                onClick={() => setSelectedWorkspace(workspace)}
                                className={`p-3 rounded-lg cursor-pointer transition ${selectedWorkspace?._id === workspace._id
                                    ? 'bg-primary-50 text-primary-700'
                                    : 'hover:bg-gray-50'
                                    }`}
                            >
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="font-medium">{workspace.name}</p>
                                        <p className="text-xs text-gray-500 mt-1">
                                            {workspace.projects?.length || 0} projects
                                        </p>
                                    </div>
                                    <button
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            handleDeleteWorkspace(workspace._id);
                                        }}
                                        className="text-gray-400 hover:text-red-600"
                                    >
                                        <FiTrash2 className="w-4 h-4" />
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="lg:col-span-3 space-y-6">
                        {selectedWorkspace && (
                            <>
                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="flex items-start justify-between">
                                        <div>
                                            <h2 className="text-2xl font-bold text-gray-900">
                                                {selectedWorkspace.name}
                                            </h2>
                                            <p className="text-gray-600 mt-2">
                                                {selectedWorkspace.description || 'No description'}
                                            </p>
                                        </div>
                                        <div className="flex space-x-2">
                                            <Button
                                                variant="outline"
                                                size="sm"
                                                onClick={() => setShowInviteModal(true)}
                                            >
                                                <FiUserPlus className="w-4 h-4 mr-2" />
                                                Invite Member
                                            </Button>
                                            <Button
                                                variant="outline"
                                                size="sm"
                                                onClick={() => {
                                                    setSelectedWorkspaceForEdit(selectedWorkspace);
                                                    setShowEditWorkspaceModal(true);
                                                }}
                                            >
                                                <FiEdit className="w-4 h-4 mr-2" />
                                                Edit
                                            </Button>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="flex items-center justify-between mb-6">
                                        <h3 className="text-xl font-semibold text-gray-900">
                                            Projects
                                        </h3>
                                        <Button
                                            size="sm"
                                            onClick={() => setShowCreateProjectModal(true)}
                                        >
                                            <FiPlus className="w-4 h-4 mr-2" />
                                            New Project
                                        </Button>
                                    </div>

                                    {projects.length === 0 ? (
                                        <EmptyState
                                            icon={FiFolder}
                                            title="No projects yet"
                                            description="Create your first project in this workspace"
                                        />
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {projects.map((project) => (
                                                <div
                                                    key={project._id}
                                                    className="p-4 border border-gray-200 rounded-lg hover:border-primary-500 hover:shadow-md transition cursor-pointer"
                                                >
                                                    <div className="flex items-start justify-between">
                                                        <div className="flex-1">
                                                            <div className="flex items-center space-x-2">
                                                                <span className="text-2xl">
                                                                    {project.icon || 'üìÅ'}
                                                                </span>
                                                                <h4 className="font-semibold text-gray-900">
                                                                    {project.name}
                                                                </h4>
                                                            </div>
                                                            <p className="text-sm text-gray-500 mt-2">
                                                                {project.description || 'No description'}
                                                            </p>
                                                        </div>
                                                        <div className="flex items-center space-x-2">
                                                            <button
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    setSelectedProjectForEdit(project);
                                                                    setShowEditProjectModal(true);
                                                                }}
                                                                className="text-gray-400 hover:text-primary-600"
                                                                title="Edit project"
                                                            >
                                                                <FiEdit className="w-5 h-5" />
                                                            </button>
                                                            <button
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    handleDeleteProject(project._id);
                                                                }}
                                                                className="text-gray-400 hover:text-red-600"
                                                                title="Delete project"
                                                            >
                                                                <FiTrash2 className="w-5 h-5" />
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </>
                        )}
                    </div>
                </div>
            )}

            {/* Create Workspace Modal */}
            <Modal
                isOpen={showCreateModal}
                onClose={() => setShowCreateModal(false)}
                title="Create Workspace"
            >
                <form onSubmit={handleCreateWorkspace} className="space-y-4">
                    <Input
                        label="Workspace Name"
                        value={newWorkspace.name}
                        onChange={(e) => setNewWorkspace({ ...newWorkspace, name: e.target.value })}
                        placeholder="My Workspace"
                        required
                    />
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                            Description
                        </label>
                        <textarea
                            value={newWorkspace.description}
                            onChange={(e) => setNewWorkspace({ ...newWorkspace, description: e.target.value })}
                            placeholder="What's this workspace for?"
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                            rows="3"
                        />
                    </div>
                    <div className="flex justify-end space-x-3 pt-4">
                        <Button
                            type="button"
                            variant="secondary"
                            onClick={() => setShowCreateModal(false)}
                        >
                            Cancel
                        </Button>
                        <Button type="submit" loading={isCreating}>
                            Create
                        </Button>
                    </div>
                </form>
            </Modal>

            {/* Create Project Modal */}
            <CreateProjectModal
                isOpen={showCreateProjectModal}
                onClose={() => setShowCreateProjectModal(false)}
                workspaceId={selectedWorkspace?._id}
            />

            {/* Edit Workspace Modal */}
            <EditWorkspaceModal
                isOpen={showEditWorkspaceModal}
                onClose={() => setShowEditWorkspaceModal(false)}
                workspace={selectedWorkspaceForEdit}
                            <div
                                key={workspace._id}
                                onClick={() => setSelectedWorkspace(workspace)}
                                className={`p-3 rounded-lg cursor-pointer transition ${selectedWorkspace?._id === workspace._id
                                    ? 'bg-primary-50 text-primary-700'
                                    : 'hover:bg-gray-50'
                                    }`}
                            >
                                <div className="flex items-center justify-between">
                                    <div>
                                        <p className="font-medium">{workspace.name}</p>
                                        <p className="text-xs text-gray-500 mt-1">
                                            {workspace.projects?.length || 0} projects
                                        </p>
                                    </div>
                                    <button
                                        onClick={(e) => {
                                            e.stopPropagation();
                                            handleDeleteWorkspace(workspace._id);
                                        }}
                                        className="text-gray-400 hover:text-red-600"
                                    >
                                        <FiTrash2 className="w-4 h-4" />
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="lg:col-span-3 space-y-6">
                        {selectedWorkspace && (
                            <>
                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="flex items-start justify-between">
                                        <div>
                                            <h2 className="text-2xl font-bold text-gray-900">
                                                {selectedWorkspace.name}
                                            </h2>
                                            <p className="text-gray-600 mt-2">
                                                {selectedWorkspace.description || 'No description'}
                                            </p>
                                        </div>
                                        <div className="flex space-x-2">
                                            <Button
                                                variant="outline"
                                                size="sm"
                                                onClick={() => setShowInviteModal(true)}
                                            >
                                                <FiUserPlus className="w-4 h-4 mr-2" />
                                                Invite Member
                                            </Button>
                                            <Button
                                                variant="outline"
                                                size="sm"
                                                onClick={() => {
                                                    setSelectedWorkspaceForEdit(selectedWorkspace);
                                                    setShowEditWorkspaceModal(true);
                                                }}
                                            >
                                                <FiEdit className="w-4 h-4 mr-2" />
                                                Edit
                                            </Button>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="flex items-center justify-between mb-6">
                                        <h3 className="text-xl font-semibold text-gray-900">
                                            Projects
                                        </h3>
                                        <Button
                                            size="sm"
                                            onClick={() => setShowCreateProjectModal(true)}
                                        >
                                            <FiPlus className="w-4 h-4 mr-2" />
                                            New Project
                                        </Button>
                                    </div>

                                    {projects.length === 0 ? (
                                        <EmptyState
                                            icon={FiFolder}
                                            title="No projects yet"
                                            description="Create your first project in this workspace"
                                        />
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {projects.map((project) => (
                                                <div
                                                    key={project._id}
                                                    className="p-4 border border-gray-200 rounded-lg hover:border-primary-500 hover:shadow-md transition cursor-pointer"
                                                >
                                                    <div className="flex items-start justify-between">
                                                        <div className="flex-1">
                                                            <div className="flex items-center space-x-2">
                                                                <span className="text-2xl">
                                                                    {project.icon || 'üìÅ'}
                                                                </span>
                                                                <h4 className="font-semibold text-gray-900">
                                                                    {project.name}
                                                                </h4>
                                                            </div>
                                                            <p className="text-sm text-gray-500 mt-2">
                                                                {project.description || 'No description'}
                                                            </p>
                                                        </div>
                                                        <div className="flex items-center space-x-2">
                                                            <button
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    setSelectedProjectForEdit(project);
                                                                    setShowEditProjectModal(true);
                                                                }}
                                                                className="text-gray-400 hover:text-primary-600"
                                                                title="Edit project"
                                                            >
                                                                <FiEdit className="w-5 h-5" />
                                                            </button>
                                                            <button
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    handleDeleteProject(project._id);
                                                                }}
                                                                className="text-gray-400 hover:text-red-600"
                                                                title="Delete project"
                                                            >
                                                                <FiTrash2 className="w-5 h-5" />
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </>
                        )}
                    </div>
                </div >
            )}

{/* Create Workspace Modal */ }
<Modal
    isOpen={showCreateModal}
    onClose={() => setShowCreateModal(false)}
    title="Create Workspace"
>
    <form onSubmit={handleCreateWorkspace} className="space-y-4">
        <Input
            label="Workspace Name"
            value={newWorkspace.name}
            onChange={(e) => setNewWorkspace({ ...newWorkspace, name: e.target.value })}
            placeholder="My Workspace"
            required
        />
        <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
                Description
            </label>
            <textarea
                value={newWorkspace.description}
                onChange={(e) => setNewWorkspace({ ...newWorkspace, description: e.target.value })}
                placeholder="What's this workspace for?"
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
                rows="3"
            />
        </div>
        <div className="flex justify-end space-x-3 pt-4">
            <Button
                type="button"
                variant="secondary"
                onClick={() => setShowCreateModal(false)}
            >
                Cancel
            </Button>
            <Button type="submit" loading={isCreating}>
                Create
            </Button>
        </div>
    </form>
</Modal>

{/* Create Project Modal */ }
<CreateProjectModal
    isOpen={showCreateProjectModal}
    onClose={() => setShowCreateProjectModal(false)}
    workspaceId={selectedWorkspace?._id}
/>

{/* Edit Workspace Modal */ }
<EditWorkspaceModal
    isOpen={showEditWorkspaceModal}
    onClose={() => setShowEditWorkspaceModal(false)}
    workspace={selectedWorkspaceForEdit}
/>

{/* Edit Project Modal */ }
<EditProjectModal
    isOpen={showEditProjectModal}
    onClose={() => {
        setShowEditProjectModal(false);
        setSelectedProjectForEdit(null);
    }}
    project={selectedProjectForEdit}
/>

{/* Invite Member Modal */ }
<Modal
    isOpen={showInviteModal}
    onClose={() => setShowInviteModal(false)}
    title="Invite Team Member"
>
    <form onSubmit={handleSendInvite} className="space-y-4">
        <Input
            label="Email Address"
            type="email"
            value={inviteEmail}
            onChange={(e) => setInviteEmail(e.target.value)}
            placeholder="colleague@example.com"
            required
        />
        <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">
                Role
            </label>
            <select
                value={inviteRole}
                onChange={(e) => setInviteRole(e.target.value)}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
            >
                <option value="member">Member</option>
                <option value="admin">Admin</option>
            </select>
            <p className="text-xs text-gray-500 mt-1">
                Members can view and contribute. Admins can manage settings.
            </p>
        </div>
        <div className="flex justify-end space-x-3 pt-4">
            <Button
                type="button"
                variant="secondary"
                onClick={() => setShowInviteModal(false)}
            >
                Cancel
            </Button>
            <Button type="submit" loading={isInviting}>
                Send Invitation
            </Button>
        </div>
    </form>
</Modal>
        </div >
    );
};

export default WorkspaceList;
